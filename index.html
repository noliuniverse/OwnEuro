<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eurovision Song Contest Simulator with Semi-Finals and Dynamic Voting</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css">
    <style>
        .eurovision-simulator {
            background: linear-gradient(135deg, #1e5799 0%,#2989d8 50%,#207cca 51%,#7db9e8 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .eurovision-simulator h1 {
            color: #FFD700;
            font-size: 3rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        .menu-card, .settings-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            margin-bottom: 20px;
        }
        .menu-card .btn {
            margin-bottom: 10px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .menu-card .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .settings-card h2 {
            color: #2989d8;
            margin-top: 20px;
            margin-bottom: 15px;
        }
        .section-header {
            background-color: #2c5282;
            color: white;
            padding: 10px;
            border-radius: 8px 8px 0 0;
            font-weight: bold;
            text-align: center;
        }
        .selection-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            border: 2px solid #4a5568;
            border-radius: 8px;
            overflow: hidden;
        }
        .selection-table th, .selection-table td {
            border: 1px solid #cbd5e0;
            padding: 8px;
        }
        .selection-table tr:hover {
            background-color: #edf2f7;
        }
        .eurovision-table {
            border-collapse: collapse;
            width: 100%;
            font-size: 14px;
        }
        .eurovision-table th, .eurovision-table td {
            border: 1px solid #ddd;
            padding: 4px;
            text-align: center;
        }
        .eurovision-table th {
            background-color: #f2f2f2;
            font-weight: bold;
            text-align: left;
        }
        .eurovision-table .receiving-country {
            text-align: right;
            font-weight: bold;
            padding-right: 10px;
        }
        .eurovision-table .flag-icon {
            margin-left: 5px;
        }
        .rotate-header {
            height: 140px;
            white-space: nowrap;
            padding: 5px 0;
        }
        .rotate-header .flag-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 15px;
        }
        .rotate-header .flag-icon {
            font-size: 12px;
        }
        .rotate-header .country-name {
            writing-mode: vertical-rl;
            transform: rotate(180deg);
            padding-top: 5px;
            text-align: left;
            max-height: 110px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .rotate-header > div {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: left;
        }
        .points-column {
            transition: display 0.5s ease-in-out;
        }
        .points-12 { background-color: gold !important; font-weight: bold !important; }
        .points-10 { background-color: #FFA500 !important; font-weight: bold !important; }
        .points-8 { background-color: #cd7f32 !important; font-weight: bold !important; }
        .points-7, .points-6, .points-5, .points-4, .points-3, .points-2, .points-1 { background-color: #ADD8E6 !important; font-weight: bold !important; }
        .self-vote { background-color: black !important; }
        .total-column {
            font-weight: bold;
            background-color: #f2f2f2;
        }
        .btn-pink {
            background-color: #FF69B4;
            border-color: #FF69B4;
            color: white;
        }
        .btn-pink:hover {
            background-color: #FF1493;
            border-color: #FF1493;
            color: white;
        }
        .even-row { background-color: #FFFFFF; }
        .odd-row { background-color: #FFFFFF; }
        .placement {
            font-weight: bold;
            text-decoration: underline;
        }
        .semi-placement {
            font-weight: bold;
            text-decoration: underline;
        }
        .form-check-input {
            width: 1.5em;
            height: 1.5em;
        }
        .form-check-label {
            margin-left: 0.5em;
        }
        .odds-input {
            width: 70px;
        }
        .non-qualifier {
            background-color: #FFCCCB;
        }
        .checkbox-container {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .country-checkbox {
            margin-right: 5px;
        }
        .aq-checkbox {
            appearance: none;
            width: 1.5em;
            height: 1.5em;
            border: 1px solid #ccc;
            border-radius: 3px;
            margin-left: 5px;
            background-color: gold;
            cursor: pointer;
        }
        .aq-checkbox:checked {
            background-color: gold;
            border-color: #FFD700;
        }
        .aq-checkbox:checked::before {
            content: '\2714';
            display: block;
            text-align: center;
            color: #000;
            font-size: 1em;
            line-height: 1.5em;
        }
        .country-name {
            margin-left: 5px;
        }
        .eurovision-table th {
            background-color: #f2f2f2;
            font-weight: bold;
            text-align: left;
        }
        .eurovision-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .eurovision-table tr:hover {
            background-color: #f5f5f5;
        }
        .non-qualifier {
            background-color: #FFCCCB !important;
        }
        .table-striped > tbody > tr:nth-of-type(odd) {
            background-color: #f9f9f9;
        }
        .table-striped > tbody > tr:nth-of-type(even) {
            background-color: #ffffff;
        }
        .table-striped > tbody > tr.non-qualifier:nth-of-type(odd),
        .table-striped > tbody > tr.non-qualifier:nth-of-type(even) {
            background-color: #FFCCCB !important;
        }
        #simulationArea {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        #simulationArea h3 {
            color: #2989d8;
            margin-bottom: 15px;
        }
        #simulationArea table {
            background-color: white;
        }
        .tele-points-revealed { 
            background-color: #FFE4B5 !important;
            font-weight: bold;
            transition: background-color 0.5s ease;
        }
        .receiving-country {
            transition: background-color 0.5s ease;
        }
        .eurovision-table tbody {
            position: relative;
        }
        .eurovision-table tbody tr {
            transition: transform 0.8s ease-in-out;
            position: relative;
        }
        .rank {
            transition: all 0.8s ease-in-out;
        }
        .fade-in {
            animation: fadeIn 0.8s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .moving-up::after,
        .moving-down::after {
            content: '';
            position: absolute;
            left: 0;
            width: 15px;
            height: 100%;
            transition: opacity 0.8s ease-in-out;
        }
        .moving-up::after {
            background-color: green;
        }
        .moving-down::after {
            background-color: red;
        }
        .reveal-button {
            width: 100%;
            font-size: 1.5em;
            padding: 15px;
            margin-top: 20px;
        }
        #timerDisplay {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
        }
        .current-televote {
            background-color: #FFFACD;
        }
        #revealTelevotingButton {
            font-size: 1.5em;
            padding: 15px;
        }
        .semi-final-charts {
            display: none;
        }
        #chartContainer {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 10px;
        }
        #dynamicVotingArea {
            margin-top: 20px;
        }
        .genre-select {
            width: 100px;
        }
        .genre-likeability {
            width: 50px;
            margin-left: 5px;
        }
        #genreLikeability {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(165px, 1fr));
            gap: 6px;
        }
        .aq-label {
            font-size: 0.8em;
            color: #666;
            display: block;
            text-align: center;
            margin-bottom: 2px;
        }
        #dynamicVotingArea {
            order: -1;
        }
	.content-wrapper {
        display: flex;
        flex-direction: column;
    }
   	#dynamicVotingArea {
        width: 100%;
        margin-top: 20px;
        margin-bottom: 20px;
    }
    #customContestants {
            min-height: 20px;
            display: revert;
        }
	.odds-column {
            display: none;
        }
    </style>
</head>
<body>
<div class="eurovision-simulator container-fluid">
    <h1 class="text-center mb-4">YOUR VERY OWN EUROVISION SIMULATOR</h1>
    <div class="row mb-4">
        <div class="col-12">
            <div class="card menu-card">
                <div class="card-body">
                    <button id="instructionsButton" class="btn btn-info mb-2">INSTRUCTIONS</button>
                    <button id="whatsNewButton" class="btn btn-warning mb-2">WHAT'S NEW?</button>
                    <button id="generateButton" class="btn btn-warning mb-2">GENERATE</button>
                    <button id="semiFinal1Button" class="btn btn-secondary mb-2" disabled>1ST SEMI CHART</button>
                    <button id="semiFinal2Button" class="btn btn-secondary mb-2" disabled>2ND SEMI CHART</button>
                    <button id="finaleButton" class="btn btn-info mb-2" disabled>FINALE CHART</button>
                    <h5> Simulate here: </h5>
                    <button id="simulateSemiDrawButton" class="btn btn-primary mb-2" disabled>SIMULATE SEMI-FINALE DRAW</button>
                    <button id="simulateButton" class="btn btn-secondary mb-2" disabled>SIMULATE SEMI-FINALE</button>
                    <button id="dynamicVotingButton" class="btn btn-success mb-2" disabled>DYNAMIC FINALE VOTING</button>
                    <button id="resetButton" class="btn btn-danger mb-2">RESET CURRENT SIMULATION</button>
                </div>
            </div>
        </div>
    </div>
 
    <div id="dynamicVotingArea" class="mb-4"></div>
 
    <div class="row">
        <div class="col-md-12">
            <div class="card settings-card">
                <div class="card-body">
                    <h5> V.1.1.0 </h5>
                    <h2>Select Participating Countries and Set Odds <br> (11-50 countries semi-finals starting with 27, odds -> lower is better):</h2>
                    <div class="row">
                        <div class="col-md-8">
                            <div class="section-header">Current Contestants</div>
                            <div class="overflow-auto" style="max-height: 400px;">
                                <table id="currentContestants" class="selection-table w-100"></table>
                            </div>
                            <button id="selectAllCurrent" class="btn btn-primary mt-2">Select All Current</button>
                            <button id="unselectAllCurrent" class="btn btn-secondary mt-2 ml-2">Unselect All Current</button>
                        </div>
                        <div class="col-md-4">
                            <div class="section-header">Old Contestants</div>
                            <div class="overflow-auto" style="max-height: 400px;">
                                <table id="oldContestants" class="selection-table w-100"></table>
                            </div>
                            <button id="selectAllOld" class="btn btn-primary mt-2">Select All Old</button>
                            <button id="unselectAllOld" class="btn btn-secondary mt-2 ml-2">Unselect All Old</button>
                        </div>
                        <button id="show_custom" class="btn btn-primary mt-2">Click here for custom contestants.</button>
                        <div id="custom_showing" style="display: none;" class="row">
                            <div class="col-md-4">
                                <div class="section-header">Custom Contestants</div>
                                <div class="overflow-auto" style="max-height: 400px;">
                                    <table id="customContestants" class="selection-table w-100"></table>
                                </div>
                                <button id="selectAllCustom" class="btn btn-primary mt-2">Select All Custom</button>
                                <button id="unselectAllCustom" class="btn btn-secondary mt-2 ml-2">Unselect All Custom</button>
                            </div>
                            <div class="col-md-4">
                                <div class="section-header">Add Contestants</div>
                                <div class="overflow-auto" style="max-height: 400px;">
                                    <div class="selection-table w-100">
                                        <input placeholder="Name" id="custom_name"/>
                                        <input placeholder="Code (E.g: Swiss is ch)" id="custom_code"/>
                                        <input placeholder="Flag (E.g: Direct link.png)" id="custom_flag"/>
                                        <button  class="btn btn-success w-100 mt-4" id="add_contestant">Add +</button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="section-header">Save Contestants</div>
                                <div class="overflow-auto" style="max-height: 400px;">
                                    <div class="selection-table w-100">
                                        <button class="btn btn-success w-100 mt-4" id="export_custom">Export</button>
                                        <button  class="btn btn-info w-100 mt-4" id="import_custom">Import</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-primary text-white">
                Odds Controls
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-6">
                        <button id="randomizeButton" class="btn btn-success w-100">Randomize All Odds</button>
                    </div>
                    <div class="col-6">
                        <button id="defaultOddsButton" class="btn btn-info w-100">Default Odds (100)</button>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-6">
                        <button id="randomizeJuryButton" class="btn btn-outline-success w-100">Randomize Jury Odds</button>
                    </div>
                    <div class="col-6">
                        <button id="randomizeTeleButton" class="btn btn-outline-success w-100">Randomize Tele Odds</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-secondary text-white">
                Odds Settings
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="maxOddsDifference" class="form-label">Max Jury-Tele Odds Difference:</label>
                    <input type="number" id="maxOddsDifference" class="form-control" value="75" min="0" max="499">
                </div>
                <div class="row">
                    <div class="col-6">
                        <label for="minOdds" class="form-label">Min Odds:</label>
                        <input type="number" id="minOdds" class="form-control" value="1" min="1" max="500">
                    </div>
                    <div class="col-6">
                        <label for="maxOdds" class="form-label">Max Odds:</label>
                        <input type="number" id="maxOdds" class="form-control" value="500" min="1" max="500">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
                    <button id="randomizeGenresButton" class="btn btn-secondary w-100 mt-2">Randomize Genres</button>
                    <button id="randomizeGenreLikeabilityButton" class="btn btn-secondary w-100 mt-2">Randomize Genre Likeability</button>
                    
                    <div class="mt-4">
                        <label for="revealTime" class="form-label">Time before revealing qualifier (seconds):</label>
                        <select id="revealTime" class="form-select">
                            <option value="5">5</option>
                            <option value="10" selected>10</option>
                            <option value="15">15</option>
                        </select>
                    </div>
                    <div class="mt-4">
                        <p class="mt-2">Genre Likeability: 1 (Least Liked) to 5 (Most Liked)</p>
                        <small class="text-muted">Higher likeability (5) improves a country's odds, while lower likeability (1) worsens them.</small>
                        <h3 class="mt-4">Genre Likeability</h3>
                        <div id="genreLikeability"></div>
                    </div>
		<div class="mt-4">
  			 <label for="votingSystem" class="form-label">Voting System:</label>
    			 <select id="votingSystem" class="form-select">
    			    <option value="current">1-8, 10, 12 with Jury Voting in Semi-Finals</option>
       			    <option value="noJurySemi">1-8, 10, 12 without Jury Voting in Semi-Finals</option>
    		</select>
		</div>	
                </div>
            </div>
        </div>
    </div>
 
    <div id="chartContainer" class="mt-4"></div>
    <div id="results" class="mt-4"></div>
</div>
 
<script>
const chartContainer = document.createElement('div');
chartContainer.id = 'chartContainer';
document.querySelector('.eurovision-simulator').appendChild(chartContainer);
const currentContestants = [
    "Albania", "Armenia", "Australia", "Austria", "Azerbaijan", "Belgium", "Bulgaria", "Croatia", "Cyprus", "Czechia",
    "Denmark", "Estonia", "Finland", "France", "Georgia", "Germany", "Greece", "Iceland", "Ireland", "Israel", "Italy", "Latvia", "Lithuania", "Luxembourg", "Malta", "Moldova", "Montenegro", "Netherlands", "North Macedonia", "Norway",
    "Poland", "Portugal", "Romania", "San Marino", "Serbia", "Slovenia", "Spain", "Sweden", "Switzerland", "Ukraine",
    "United Kingdom"
];
 
const oldContestants = [
    "Andorra", "Belarus", "Bosnia & Herz.", "Hungary", "Monaco", "Morocco", "Russia", "Slovakia", "Turkey"
];
 
var customContestants = []
 
var customContestantsFlag = []
 
const genres = ["Pop", "Disco", "Dark Pop", "Pop Ballad", "Power Ballad", "Folk", "Country", "Jazz", "Rock", "Punk", "Heavy Metal", "Techno", "Rap"];
let genreLikeability = {};
genres.forEach(genre => genreLikeability[genre] = 3);
 
function randomizeGenreLikeability() {
    genres.forEach(genre => {
        genreLikeability[genre] = Math.floor(Math.random() * 5) + 1;
    });
    updateGenreLikeabilityUI();
}
 
function updateGenreLikeabilityUI() {
    document.querySelectorAll('.genre-likeability').forEach(input => {
        input.value = genreLikeability[input.dataset.genre];
    });
}
 
document.getElementById('randomizeGenreLikeabilityButton').addEventListener('click', randomizeGenreLikeability);
 
var customcountryCodeMap = {}
 
function getCountryCode(countryName) {
    const countryCodeMap = {
        "Albania": "al", "Armenia": "am", "Australia": "au", "Austria": "at", "Azerbaijan": "az",
        "Belgium": "be", "Bulgaria": "bg", "Croatia": "hr", "Cyprus": "cy", "Czechia": "cz",
        "Denmark": "dk", "Estonia": "ee", "Finland": "fi", "France": "fr", "Georgia": "ge",
        "Germany": "de", "Greece": "gr", "Iceland": "is", "Ireland": "ie", "Israel": "il",
        "Italy": "it", "Latvia": "lv", "Lithuania": "lt", "Luxembourg": "lu", "Malta": "mt",
        "Moldova": "md", "Montenegro": "me", "Netherlands": "nl", "North Macedonia": "mk", "Norway": "no",
        "Poland": "pl", "Portugal": "pt", "Romania": "ro", "San Marino": "sm", "Serbia": "rs",
        "Slovenia": "si", "Spain": "es", "Sweden": "se", "Switzerland": "ch", "Ukraine": "ua",
        "United Kingdom": "gb", "Andorra": "ad", "Belarus": "by", "Bosnia & Herz.": "ba",
        "Hungary": "hu", "Monaco": "mc", "Morocco": "ma", "Russia": "ru", "Slovakia": "sk",
        "Turkey": "tr"
    };
    return (countryCodeMap[countryName] || customcountryCodeMap[countryName]) || "unknown";
}
 
function createCountryTable(containerId, countries) {
    const container = document.getElementById(containerId);
    container.querySelectorAll('.jury-odds-input, .tele-odds-input').forEach(input => {
        input.addEventListener('change', validateOddsDifference);
    });
    let html = '';
    for (let i = 0; i < countries.length; i += 3) {
        html += '<tr>';
        for (let j = i; j < Math.min(i + 3, countries.length); j++) {
            html += `
                <td>
                    <div class="checkbox-container">
                        <input class="form-check-input country-checkbox" type="checkbox" value="${countries[j]}">
                        <span class="aq-label">AQ</span>
                        <input class="aq-checkbox" type="checkbox" value="${countries[j]}" title="Auto-qualifier">
                        <span class="country-name">
                            ${countries[j]}
                            <span class="flag-icon flag-icon-${getCountryCode(countries[j])} ml-2"></span>
                        </span>
                    </div>
                    <div class="odds-inputs">
                        <input type="number" class="form-control jury-odds-input" min="1" max="500" value="100" placeholder="Jury Odds">
                        <input type="number" class="form-control tele-odds-input" min="1" max="500" value="100" placeholder="Tele Odds">
                    </div>
                    <select class="genre-select">
                        ${genres.map(genre => `<option value="${genre}">${genre}</option>`).join('')}
                    </select>
                </td>
            `;
        }
        html += '</tr>';
    }
    container.innerHTML = html;
}
 
createCountryTable('currentContestants', currentContestants);
createCountryTable('oldContestants', oldContestants);
createCountryTable('customContestants', customContestants);
 
 
const generateButton = document.getElementById('generateButton');
const randomizeButton = document.getElementById('randomizeButton');
const defaultOddsButton = document.getElementById('defaultOddsButton');
const resultsDiv = document.getElementById('results');
const semiFinal1Button = document.getElementById('semiFinal1Button');
const semiFinal2Button = document.getElementById('semiFinal2Button');
const finaleButton = document.getElementById('finaleButton');
const selectAllCurrentButton = document.getElementById('selectAllCurrent');
const selectAllOldButton = document.getElementById('selectAllOld');
const selectAllCustomButton = document.getElementById('selectAllCustom');
const unselectAllCurrentButton = document.getElementById('unselectAllCurrent');
const unselectAllOldButton = document.getElementById('unselectAllOld');
const unselectAllCustomButton = document.getElementById('unselectAllCustom');
const simulateButton = document.getElementById('simulateButton');
const dynamicVotingButton = document.getElementById('dynamicVotingButton');
const dynamicVotingArea = document.getElementById('dynamicVotingArea');
const addCustomContestantButton = document.getElementById('add_contestant');
const showCustomContestantButton = document.getElementById('show_custom');
const importCustomContestantButton = document.getElementById('import_custom');
const exportCustomContestantButton = document.getElementById('export_custom');
const randomizeJuryButton = document.getElementById('randomizeJuryButton');
const randomizeTeleButton = document.getElementById('randomizeTeleButton');
 
let semiFinal1Results, semiFinal2Results, finalResults;
let currentSemiFinal = 1;
 
let selectedVotingSystem = 'current';

document.getElementById('votingSystem').addEventListener('change', (e) => {
    selectedVotingSystem = e.target.value;
});

function randomizeGenres() {
    document.querySelectorAll('.genre-select').forEach(select => {
        const randomIndex = Math.floor(Math.random() * genres.length);
        select.selectedIndex = randomIndex;
    });
}
 
function calculateGenreBonus(selectedCountries) {
    const genreCounts = {};
    genres.forEach(genre => genreCounts[genre] = 0);
 
    selectedCountries.forEach(country => {
        genreCounts[country.genre]++;
    });
 
    const totalCountries = selectedCountries.length;
    const genreBonuses = {};
 
    Object.entries(genreCounts).forEach(([genre, count]) => {
        const percentage = (count / totalCountries) * 100;
        if (percentage > 30) {
            genreBonuses[genre] = 1.05;
        } else if (percentage <= 10) {
            genreBonuses[genre] = 0.9;
        } else {
            genreBonuses[genre] = 1;
        }
    });
 
    return genreBonuses;
}

randomizeJuryButton.addEventListener('click', () => {
    const minOdds = parseInt(document.getElementById('minOdds').value);
    const maxOdds = parseInt(document.getElementById('maxOdds').value);
    const maxDifference = parseInt(document.getElementById('maxOddsDifference').value);

    document.querySelectorAll('.odds-inputs').forEach(container => {
        const juryInput = container.querySelector('.jury-odds-input');
        const teleInput = container.querySelector('.tele-odds-input');

        const teleOdds = parseInt(teleInput.value);
        const juryOdds = getRandomOdds(minOdds, maxOdds, teleOdds, maxDifference);

        juryInput.value = juryOdds;
    });
});

randomizeTeleButton.addEventListener('click', () => {
    const minOdds = parseInt(document.getElementById('minOdds').value);
    const maxOdds = parseInt(document.getElementById('maxOdds').value);
    const maxDifference = parseInt(document.getElementById('maxOddsDifference').value);

    document.querySelectorAll('.odds-inputs').forEach(container => {
        const juryInput = container.querySelector('.jury-odds-input');
        const teleInput = container.querySelector('.tele-odds-input');

        const juryOdds = parseInt(juryInput.value);
        const teleOdds = getRandomOdds(minOdds, maxOdds, juryOdds, maxDifference);

        teleInput.value = teleOdds;
    });
});
 
randomizeButton.addEventListener('click', () => {
    const minOdds = parseInt(document.getElementById('minOdds').value);
    const maxOdds = parseInt(document.getElementById('maxOdds').value);
    const maxDifference = parseInt(document.getElementById('maxOddsDifference').value);

    document.querySelectorAll('.odds-inputs').forEach(container => {
        const juryInput = container.querySelector('.jury-odds-input');
        const teleInput = container.querySelector('.tele-odds-input');

        const baseOdds = Math.floor(Math.random() * (maxOdds - minOdds + 1)) + minOdds;
        const juryOdds = baseOdds;
        const teleOdds = getRandomOdds(minOdds, maxOdds, baseOdds, maxDifference);

        juryInput.value = juryOdds;
        teleInput.value = teleOdds;
    });
});

document.querySelectorAll('.jury-odds-input, .tele-odds-input').forEach(input => {
    input.addEventListener('change', validateOddsDifference);
});
 
defaultOddsButton.addEventListener('click', () => {
    document.querySelectorAll('.jury-odds-input, .tele-odds-input').forEach(input => {
        input.value = 100;
    });
});

function validateOddsDifference(event) {
    const container = event.target.closest('.odds-inputs');
    const juryInput = container.querySelector('.jury-odds-input');
    const teleInput = container.querySelector('.tele-odds-input');
    const maxDifference = parseInt(document.getElementById('maxOddsDifference').value);

    const juryOdds = parseInt(juryInput.value);
    const teleOdds = parseInt(teleInput.value);

    if (Math.abs(juryOdds - teleOdds) > maxDifference) {
        alert(`The difference between Jury and Televoting odds cannot exceed ${maxDifference}.`);
        event.target.value = event.target === juryInput ? teleOdds : juryOdds;
    }
}
 
[selectAllCurrentButton, selectAllOldButton, selectAllCustomButton].forEach(button => {
    button.addEventListener('click', () => {
        console.log(`Select All button clicked: ${button.id}`);
        const tableId = button.id.replace('selectAll', '').toLowerCase();
        document.querySelectorAll(`#${tableId}Contestants .country-checkbox`).forEach(checkbox => {
            checkbox.checked = true;
        });
        updateAQCheckboxStatus();
    });
});

[unselectAllCurrentButton, unselectAllOldButton, unselectAllCustomButton].forEach(button => {
    button.addEventListener('click', () => {
        console.log(`Unselect All button clicked: ${button.id}`);
        const tableId = button.id.replace('unselectAll', '').toLowerCase();
        document.querySelectorAll(`#${tableId}Contestants .country-checkbox`).forEach(checkbox => {
            checkbox.checked = false;
        });
        updateAQCheckboxStatus();
    });
});
 
function makeid(length) {
    let result = '';
    const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    const charactersLength = characters.length;
    let counter = 0;
    while (counter < length) {
      result += characters.charAt(Math.floor(Math.random() * charactersLength));
      counter += 1;
    }
    return result;
}
 
const addCSS = css => document.head.appendChild(document.createElement("style")).innerHTML=css;
 
addCustomContestantButton.addEventListener('click', () => {
    var con_name = "";
    if (document.getElementById('custom_name').value.replace(/\s/g, '') == "") {
        con_name = String(Date.now())+Math.floor(Math.random()*10000)
        customContestants.push(con_name)
    } else {
        con_name = document.getElementById('custom_name').value;
        customContestants.push(con_name)
    }
    var con_code = "";
    if (document.getElementById('custom_code').value.replace(/\s/g, '') == "") {
        con_code = makeid(4)
        customcountryCodeMap[con_name] = String(con_code);
    } else {
        con_code = document.getElementById('custom_code').value;
        customcountryCodeMap[con_name] = String(con_code);
    }
    if (document.getElementById('custom_flag').value.replace(/\s/g, '') == "") {
        //pass
    } else {
        customContestantsFlag.push(document.getElementById('custom_flag').value.replace(/\s/g, ''));
        addCSS(`.flag-icon-${con_code}{ background-image: url("${document.getElementById('custom_flag').value.replace(/\s/g, '')}"); }`)
    }
    createCountryTable('customContestants', customContestants);
    document.getElementById('custom_name').value = "";
    document.getElementById('custom_code').value = "";
    document.getElementById('custom_flag').value = "";

    document.querySelectorAll('#customContestants .country-checkbox').forEach(addCheckboxListeners);

    updateAQCheckboxStatus();
});
 
showCustomContestantButton.addEventListener('click', () => {
    document.getElementById('custom_showing').style.display = document.getElementById('custom_showing').style.display == "none" ? "flex" : "none";
})
 
importCustomContestantButton.addEventListener('click', async () => {
    //customContestants.
    let str = prompt("Enter your export: (The export will not overwrite contestants you have already entered.)");
    const saveList = JSON.parse(str)
    console.log(saveList)
    customContestants = [...customContestants, ...saveList[0]];
    customcountryCodeMap = {...customcountryCodeMap, ...saveList[1]};
    customContestantsFlag = [...customContestantsFlag, ...saveList[2]];
    for (var i = 0; i < saveList[0].length; i++) {
        addCSS(`.flag-icon-${saveList[1][Object.keys(saveList[1])[i]].replace(/\s/g, '')}{ background-image: url("${saveList[2][i].replace(/\s/g, '')}"); }`)
    }
 
    alert("Imported!")
    createCountryTable('customContestants', customContestants);
})
 
 
exportCustomContestantButton.addEventListener('click', async () => {
    var res = JSON.stringify([customContestants, customcountryCodeMap, customContestantsFlag]);
    await navigator.clipboard.writeText(res);
    alert("Exported, and copied to your clipboard. Save this data somewhere so you don't lose it.")
})
 
 
function hideSettingsShowSimulation() {
    document.querySelector('.settings-card').style.display = 'none';
    resultsDiv.innerHTML = '';
 
    const simulationArea = document.createElement('div');
    simulationArea.id = 'simulationArea';
    simulationArea.innerHTML = `
        <div id="timerDisplay" class="mt-3 text-center"></div>
        <div class="row">
            <div class="col-md-6">
                <h3>Semi-Final ${currentSemiFinal} Countries</h3>
                <table id="semiFinalTable" class="table table-striped">
                    <thead>
                        <tr>
                            <th>Country</th>
                            <th>Genre</th>
                            <th>Jury Odds</th>
                            <th>Tele Odds</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="col-md-6">
                <h3>Qualified Countries</h3>
                <table id="qualifiedTable" class="table table-striped">
                    <thead>
                        <tr>
                            <th>Country</th>
                            <th>Genre</th>
                            <th>Jury Odds</th>
                            <th>Tele Odds</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        <button id="nextSemiFinalButton" class="btn btn-primary mt-3" style="display: none;">Proceed to Semi-Final 2</button>
        <div class="semi-final-charts"></div>
    `;
 
    document.querySelector('.settings-card').insertAdjacentElement('afterend', simulationArea);
}
 
function populateSemiFinalTable(results) {
    const table = document.getElementById('semiFinalTable').getElementsByTagName('tbody')[0];
    table.innerHTML = '';

    const sortedCountries = Object.entries(results)
        .sort(([a], [b]) => a.localeCompare(b));

    sortedCountries.forEach(([country, data]) => {
        const row = table.insertRow();
        row.innerHTML = `
            <td>
                ${country}
                <span class="flag-icon flag-icon-${getCountryCode(country)} ml-2"></span>
            </td>
            <td>${data.genre}</td>
            <td>${data.juryOdds}</td>
            <td>${data.teleOdds}</td>
        `;
    });
}
 
generateButton.addEventListener('click', () => {
    const selectedCountries = Array.from(document.querySelectorAll('.country-checkbox:checked'))
        .map(checkbox => {
            const containerDiv = checkbox.closest('.checkbox-container');
            const juryOddsInput = containerDiv.nextElementSibling.querySelector('.jury-odds-input');
            const teleOddsInput = containerDiv.nextElementSibling.querySelector('.tele-odds-input');
            const genreSelect = containerDiv.nextElementSibling.nextElementSibling;
            const juryOdds = parseInt(juryOddsInput.value) || 100;
            const teleOdds = parseInt(teleOddsInput.value) || 100;
            const isAQ = containerDiv.querySelector('.aq-checkbox').checked;
            const genre = genreSelect.value;
            return { name: checkbox.value, juryOdds: juryOdds, teleOdds: teleOdds, isAQ: isAQ, genre: genre };
        });

    if (selectedCountries.length < 10 || selectedCountries.length > 50) {
        alert('Please select between 11 and 50 countries.');
        return;
    }

    const autoQualifiers = selectedCountries.filter(country => country.isAQ);
    if (autoQualifiers.length > 10) {
        alert('You can select a maximum of 10 auto-qualifiers.');
        return;
    }

 
    const genreBonuses = calculateGenreBonus(selectedCountries);
 
    resultsDiv.innerHTML = '<div class="text-center my-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p>Generating results...</p></div>';
 
     setTimeout(() => {
        if (selectedCountries.length > 26) {
            const contestResults = runContest(selectedCountries, genreBonuses);
            semiFinal1Results = contestResults.semiFinal1;
            semiFinal2Results = contestResults.semiFinal2;
            finalResults = contestResults.finalResults;
            displayFinalResults(finalResults);
            semiFinal1Button.disabled = false;
            semiFinal2Button.disabled = false;
            semiFinal1Button.classList.add('btn-pink');
            semiFinal2Button.classList.add('btn-pink');
 
            document.querySelector('.settings-card').style.display = 'none';
            resultsDiv.innerHTML = '<button id="showChartsButton" style="display: none;"> class="btn btn-info mt-3">Show Semi-Final Charts</button>';
 
            document.getElementById('showChartsButton').addEventListener('click', function() {
                chartContainer.style.display = 'block';
                chartContainer.innerHTML = `
                    ${createSemiFinalTable(semiFinal1Results)}
                    ${createSemiFinalTable(semiFinal2Results)}
                    ${selectedVotingSystem === 'current' ? createVotingChart(semiFinal1Results, "Jury Voting - Semi-Final 1", false) : ''}
                    ${createVotingChart(semiFinal1Results, "Televoting - Semi-Final 1", true)}
                    ${selectedVotingSystem === 'current' ? createVotingChart(semiFinal2Results, "Jury Voting - Semi-Final 2", false) : ''}
                    ${createVotingChart(semiFinal2Results, "Televoting - Semi-Final 2", true)}
                `;
                this.style.display = 'none';
            });
 
            simulateButton.disabled = false;
            document.getElementById('simulateSemiDrawButton').disabled = false;
        } else {
            const contestResults = generateVotingResults(selectedCountries, null, genreBonuses);
            finalResults = contestResults;
            displayResults(contestResults.results, selectedCountries, contestResults.votingOrder);
            semiFinal1Button.disabled = true;
            semiFinal2Button.disabled = true;
            semiFinal1Button.classList.remove('btn-pink');
            semiFinal2Button.classList.remove('btn-pink');
        }
        finaleButton.disabled = false;
        dynamicVotingButton.disabled = false;
    }, 1000);
});

updateAQCheckboxStatus();
 
semiFinal1Button.addEventListener('click', () => {
    displaySemiFinals(semiFinal1Results, "Semi-Final 1");
});
 
semiFinal2Button.addEventListener('click', () => {
    displaySemiFinals(semiFinal2Results, "Semi-Final 2");
});
 
finaleButton.addEventListener('click', () => {
    if (finalResults.results) {
        displayFinalResults(finalResults);
    } else {
        displayResults(finalResults.results, Object.keys(finalResults.results).map(name => ({ name, odds: finalResults.results[name].odds, genre: finalResults.results[name].genre })), finalResults.votingOrder);
    }
});
 
simulateButton.addEventListener('click', () => {
    simulateButton.disabled = true;
    hideSettingsShowSimulation();
    populateSemiFinalTable(currentSemiFinal === 1 ? semiFinal1Results.results : semiFinal2Results.results);
 
    const semiFinalTable = document.getElementById('semiFinalTable').getElementsByTagName('tbody')[0];
    const qualifiedTable = document.getElementById('qualifiedTable').getElementsByTagName('tbody')[0];
    const timerDisplay = document.getElementById('timerDisplay');
    const revealTime = parseInt(document.getElementById('revealTime').value);
 
    const allCountries = Array.from(semiFinalTable.rows).map(row => ({
        element: row,
        country: row.cells[0].textContent.trim(),
        genre: row.cells[1].textContent.trim(),
        points: currentSemiFinal === 1 
            ? semiFinal1Results.results[row.cells[0].textContent.trim()].juryTotal + 
              semiFinal1Results.results[row.cells[0].textContent.trim()].teleTotal
            : semiFinal2Results.results[row.cells[0].textContent.trim()].juryTotal + 
              semiFinal2Results.results[row.cells[0].textContent.trim()].teleTotal
    }));
 
    const topTen = allCountries
        .sort((a, b) => b.points - a.points)
        .slice(0, 10);
 
    for (let i = topTen.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [topTen[i], topTen[j]] = [topTen[j], topTen[i]];
    }
 
    function updateTimer(secondsLeft) {
        timerDisplay.textContent = `Next country in: ${secondsLeft} seconds`;
    }
 
    function revealCountry(index) {
        if (index < topTen.length) {
            let secondsLeft = revealTime;
            const countdownInterval = setInterval(() => {
                if (secondsLeft > 0) {
                    updateTimer(secondsLeft);
                    secondsLeft--;
                } else {
                    clearInterval(countdownInterval);
                    const countryData = topTen[index];
                    const newRow = qualifiedTable.insertRow();
                    newRow.innerHTML = countryData.element.innerHTML;
                    newRow.classList.add('table-success');
 
                    semiFinalTable.deleteRow(Array.from(semiFinalTable.rows).indexOf(countryData.element));
 
                    revealCountry(index + 1);
                }
            }, 1000);
        } else {
            timerDisplay.textContent = 'All countries revealed!';
            if (currentSemiFinal === 1) {
                document.getElementById('nextSemiFinalButton').style.display = 'block';
            } else {
                document.getElementById('finaleButton').disabled = false;
                document.getElementById('dynamicVotingButton').disabled = false;
            }
            simulateButton.disabled = false;
        }
    }
 
    revealCountry(0);
});
 
document.addEventListener('click', function(e) {
    if (e.target && e.target.id === 'nextSemiFinalButton') {
        currentSemiFinal = 2;
        hideSettingsShowSimulation();
        populateSemiFinalTable(semiFinal2Results.results);
        simulateButton.disabled = false;
        e.target.style.display = 'none';
 
        const existingSimulationArea = document.getElementById('simulationArea');
        if (existingSimulationArea) {
            existingSimulationArea.remove();
        }
    }
 
    if (e.target && e.target.id === 'showChartsButton') {
        const chartsDiv = document.querySelector('.semi-final-charts');
        chartsDiv.style.display = 'block';
        chartsDiv.innerHTML = `
            ${createVotingChart(currentSemiFinal === 1 ? semiFinal1Results : semiFinal2Results, `Jury Voting - Semi-Final ${currentSemiFinal}`, false)}
            ${createVotingChart(currentSemiFinal === 1 ? semiFinal1Results : semiFinal2Results, `Televoting - Semi-Final ${currentSemiFinal}`, true)}
            ${createSemiFinalTable(currentSemiFinal === 1 ? semiFinal1Results : semiFinal2Results)}
        `;
        e.target.style.display = 'none';
    }
});
 
 
function getRandomOdds(min, max, baseOdds, maxDifference) {
    const lowerBound = Math.max(min, baseOdds - maxDifference);
    const upperBound = Math.min(max, baseOdds + maxDifference);
    return Math.floor(Math.random() * (upperBound - lowerBound + 1)) + lowerBound;
}
 
function calculateWeight(odds) {
    const base = Math.min(odds, 500);
    const weight = Math.max(1, Math.round(100000 / (Math.pow(base, 1.5) + 100)));
    return weight;
}
 
function createWeightedCountries(availableCountries, oddsType) {
    const weights = availableCountries.map(country => {
        const odds = results[country.name] ? results[country.name][oddsType] : country[oddsType];
        return { country: country.name, weight: calculateWeight(odds) };
    });

    const totalWeight = weights.reduce((sum, item) => sum + item.weight, 0);
    const scaleFactor = 10000 / totalWeight;

    return weights.map(item => ({
        country: item.country,
        weight: Math.max(1, Math.round(item.weight * scaleFactor))
    }));
}
 
function selectVotingCountries(weightedCountries) {
    const selectedCountries = [];
    const points = [12, 10, 8, 7, 6, 5, 4, 3, 2, 1];
 
    for (let i = 0; i < points.length; i++) {
        let totalWeight = weightedCountries.reduce((sum, country) => sum + country.weight, 0);
        let randomWeight = Math.random() * totalWeight;
        let selectedCountry;
 
        for (const country of weightedCountries) {
            randomWeight -= country.weight;
            if (randomWeight <= 0) {
                selectedCountry = country.country;
                break;
            }
        }
 
        if (selectedCountry) {
            selectedCountries.push(selectedCountry);
            weightedCountries = weightedCountries.filter(c => c.country !== selectedCountry);
        } else {
            const remainingCountry = weightedCountries[Math.floor(Math.random() * weightedCountries.length)].country;
            selectedCountries.push(remainingCountry);
            weightedCountries = weightedCountries.filter(c => c.country !== remainingCountry);
        }
    }
 
    return selectedCountries;
}
 
function generateVotingResults(countries, votingCountries = null, genreBonuses) {
    const results = {};
    const allCountries = votingCountries || countries;

    allCountries.forEach(country => {
        const genreBonus = genreBonuses[country.genre] || 1;
        const likeabilityFactor = (1 + genreLikeability[country.genre]) / 4;
        const adjustedJuryOdds = Math.round(country.juryOdds * genreBonus * likeabilityFactor);
        const adjustedTeleOdds = Math.round(country.teleOdds * genreBonus * likeabilityFactor);

        results[country.name] = { 
            juryTotal: 0, 
            teleTotal: 0, 
            juryVotesGiven: {}, 
            teleVotesGiven: {}, 
            juryOdds: adjustedJuryOdds,
            teleOdds: adjustedTeleOdds,
            juryPlacement: 0,
            telePlacement: 0,
            isAQ: country.isAQ,
            isCompeting: countries.some(c => c.name === country.name),
            genre: country.genre
        };
    });

    const points = [12, 10, 8, 7, 6, 5, 4, 3, 2, 1];
    const votingOrder = (votingCountries || countries).map(c => c.name).sort(() => 0.5 - Math.random());

    votingOrder.forEach(voter => {
        const availableCountries = countries.filter(c => c.name !== voter);
        const teleWeightedCountries = createWeightedCountries(availableCountries, 'teleOdds');
        const teleVotedCountries = selectVotingCountries(teleWeightedCountries);

        if (results[voter]) {
            // Always calculate televoting
            teleVotedCountries.forEach((country, index) => {
                results[voter].teleVotesGiven[country] = points[index];
                results[country].teleTotal += points[index];
            });

            // Only calculate jury voting if it's the final or if using the current system in semi-finals
            if (selectedVotingSystem === 'current' || votingCountries) {
                const juryWeightedCountries = createWeightedCountries(availableCountries, 'juryOdds');
                const juryVotedCountries = selectVotingCountries(juryWeightedCountries);
                juryVotedCountries.forEach((country, index) => {
                    results[voter].juryVotesGiven[country] = points[index];
                    results[country].juryTotal += points[index];
                });
            }
        }
    });

    const sortedTele = Object.keys(results)
        .filter(country => results[country].isCompeting)
        .sort((a, b) => results[b].teleTotal - results[a].teleTotal);

    if (selectedVotingSystem === 'current' || votingCountries) {
        sortedTele.forEach((country, index) => {
            results[country].telePlacement = results[country].teleTotal > 0 ? index + 1 : `<p style="color:red;">${sortedTele.length} (0p)</p>`;
        });

        const sortedJury = Object.keys(results)
            .filter(country => results[country].isCompeting)
            .sort((a, b) => results[b].juryTotal - results[a].juryTotal);

        sortedJury.forEach((country, index) => {
            results[country].juryPlacement = results[country].juryTotal > 0 ? index + 1 : `<p style="color:red;">${sortedJury.length} (0p)</p>`;
        });
    }

    return { results, votingOrder };
}

 
function runContest(countries, genreBonuses) {
    if (countries.length <= 26) {
        return generateVotingResults(countries, null, genreBonuses);
    } else {
        const autoQualifiers = countries.filter(c => c.isAQ).slice(0, 10);
        const remainingCountries = countries.filter(c => !c.isAQ);

        const shuffledCountries = [...remainingCountries].sort(() => 0.5 - Math.random());
        const semiFinal1Countries = shuffledCountries.slice(0, Math.ceil(shuffledCountries.length / 2));
        const semiFinal2Countries = shuffledCountries.slice(Math.ceil(shuffledCountries.length / 2));

        const semiFinal1 = generateVotingResults(semiFinal1Countries, null, genreBonuses);
        const semiFinal2 = generateVotingResults(semiFinal2Countries, null, genreBonuses);

        const qualifiersPerSemi = 10;
        const semiFinal1Qualifiers = getQualifiers(semiFinal1.results, qualifiersPerSemi);
        const semiFinal2Qualifiers = getQualifiers(semiFinal2.results, qualifiersPerSemi);

        const finalCountries = [...autoQualifiers, ...semiFinal1Qualifiers, ...semiFinal2Qualifiers];
        const allVotingCountries = [...countries];
        const finalResults = generateVotingResults(finalCountries, allVotingCountries, genreBonuses);

        return { semiFinal1, semiFinal2, finalResults };
    }
}

function updateAQCheckboxStatus() {
    const totalSelectedCountries = 
        document.querySelectorAll('#currentContestants .country-checkbox:checked').length +
        document.querySelectorAll('#oldContestants .country-checkbox:checked').length +
        document.querySelectorAll('#customContestants .country-checkbox:checked').length;

    const shouldEnableAQ = totalSelectedCountries >= 27;

    document.querySelectorAll('.country-checkbox').forEach(checkbox => {
        const aqCheckbox = checkbox.nextElementSibling.nextElementSibling;
        if (checkbox.checked && shouldEnableAQ) {
            aqCheckbox.disabled = false;
        } else {
            aqCheckbox.disabled = true;
            aqCheckbox.checked = false;
        }
    });

    console.log(`Total selected countries: ${totalSelectedCountries}, AQ enabled: ${shouldEnableAQ}`);
}

function addCheckboxListeners(checkbox) {
    checkbox.addEventListener('change', () => {
        console.log(`Checkbox for ${checkbox.value} changed. Checked: ${checkbox.checked}`);
        updateAQCheckboxStatus();
    });
}

document.querySelectorAll('.country-checkbox').forEach(addCheckboxListeners);


 
function displayResults(results, countries, votingOrder) {
    let html = `
        ${createVotingChart({ results, votingOrder }, "Jury Voting - Final", false)}
        ${createVotingChart({ results, votingOrder }, "Televoting - Final", true)}
        <h2 class="results-headline">Final Results</h2>
        <table class="table table-striped eurovision-table">
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Country</th>
                    <th>Genre</th>
                    <th>Jury Points</th>
                    <th>Tele Points</th>
                    <th>Total Points</th>
                    <th>Jury Odds</th>
                    <th>Tele Odds</th>
                    <th>Jury Placement</th>
                    <th>Tele Placement</th>
                </tr>
            </thead>
            <tbody>
    `;

    const sortedCountries = countries.sort((a, b) => {
        const totalA = results[a.name].juryTotal + results[a.name].teleTotal;
        const totalB = results[b.name].juryTotal + results[b.name].teleTotal;
        if (totalA !== totalB) return totalB - totalA;
        if (results[a.name].teleTotal !== results[b.name].teleTotal) return results[b.name].teleTotal - results[a.name].teleTotal;
        return tiebreaker(results[b.name], results[a.name]);
    });

    sortedCountries.forEach((country, index) => {
        html += `<tr>
                <td>${index + 1}</td>
                <td style="text-align: right;">
                    ${country.name}
                    <span class="flag-icon flag-icon-${getCountryCode(country.name)} ml-2"></span>
                </td>
                <td>${results[country.name].genre}</td>
                <td class="points">${results[country.name].juryTotal}</td>
                <td class="points">${results[country.name].teleTotal}</td>
                <td class="points">${results[country.name].juryTotal + results[country.name].teleTotal}</td>
                <td class="placement">${results[country.name].juryOdds}</td>
                <td class="placement">${results[country.name].teleOdds}</td>
                <td class="placement">${results[country.name].juryPlacement}</td>
                <td class="placement">${results[country.name].telePlacement}</td>
            </tr>
        `;
    });

    html += `
            </tbody>
        </table>
    `;

    resultsDiv.innerHTML = html;
}
 
function getQualifiers(results, count) {
    const sortedCountries = Object.entries(results)
        .sort((a, b) => {
            if (selectedVotingSystem === 'current') {
                const totalA = a[1].juryTotal + a[1].teleTotal;
                const totalB = b[1].juryTotal + b[1].teleTotal;
                if (totalA !== totalB) return totalB - totalA;
            }
            return b[1].teleTotal - a[1].teleTotal;
        });

    return sortedCountries.slice(0, count).map(([name, data]) => ({ 
        name, 
        juryOdds: data.juryOdds, 
        teleOdds: data.teleOdds, 
        genre: data.genre 
    }));
}

 
function displaySemiFinals(semiFinal, title) {
    chartContainer.style.display = 'block';
    chartContainer.innerHTML = `
        <h3 class="results-headline">${title} Results</h3>
        ${createSemiFinalTable(semiFinal)}
        ${selectedVotingSystem === 'current' ? createVotingChart(semiFinal, `Jury Voting - ${title}`, false) : ''}
        ${createVotingChart(semiFinal, `Televoting - ${title}`, true)}
    `;
}
 
function createSemiFinalTable(semiFinal) {
    const sortedCountries = Object.keys(semiFinal.results)
        .sort((a, b) => {
            if (selectedVotingSystem === 'current') {
                const totalA = semiFinal.results[a].juryTotal + semiFinal.results[a].teleTotal;
                const totalB = semiFinal.results[b].juryTotal + semiFinal.results[b].teleTotal;
                if (totalA !== totalB) return totalB - totalA;
            }
            return semiFinal.results[b].teleTotal - semiFinal.results[a].teleTotal;
        });

    let html = `
        <table class="table table-striped eurovision-table">
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Country</th>
                    <th>Genre</th>
                    ${selectedVotingSystem === 'current' ? '<th>Jury Points</th>' : ''}
                    <th>Tele Points</th>
                    ${selectedVotingSystem === 'current' ? '<th>Total Points</th>' : ''}
                    ${selectedVotingSystem === 'current' ? '<th>Jury Odds</th>' : ''}
                    <th>Tele Odds</th>
                    ${selectedVotingSystem === 'current' ? '<th>Jury Placement</th>' : ''}
                    ${selectedVotingSystem === 'current' ? '<th>Tele Placement</th>' : ''}
                </tr>
            </thead>
            <tbody>
    `;

    sortedCountries.forEach((country, index) => {
        const result = semiFinal.results[country];
        const isQualified = index < 10;
        html += `
            <tr class="${isQualified ? '' : 'non-qualifier'}">
                <td>${index + 1}</td>
                <td style="text-align: right;">
                    ${country}
                    <span class="flag-icon flag-icon-${getCountryCode(country)} ml-2"></span>
                </td>
                <td>${result.genre}</td>
                ${selectedVotingSystem === 'current' ? `<td class="points">${result.juryTotal}</td>` : ''}
                <td class="points">${result.teleTotal}</td>
                ${selectedVotingSystem === 'current' ? `<td class="points">${result.juryTotal + result.teleTotal}</td>` : ''}
                ${selectedVotingSystem === 'current' ? `<td class="points">${result.juryTotal + result.teleOdds}</td>` : ''}
                <td class="points">${result.teleOdds}</td>
                ${selectedVotingSystem === 'current' ? `<td class="semi-placement">${result.juryPlacement}</td>` : ''}
                ${selectedVotingSystem === 'current' ? `<td class="semi-placement">${result.telePlacement}</td>` : ''}
            </tr>
        `;
    });

    html += `
            </tbody>
        </table>
    `;

    return html;
}
 
function createVotingChart(results, title, isTele = false) {
    if (!isTele && selectedVotingSystem === 'noJurySemi' && !title.includes('Final')) {
        return ''; // Don't create jury voting chart for semi-finals in no-jury system
    }

    const { results: voteResults, votingOrder } = results;
    const sortedCountries = Object.keys(voteResults)
        .filter(country => voteResults[country].isCompeting)
        .sort((a, b) => {
            const totalA = isTele ? voteResults[a].teleTotal : voteResults[a].juryTotal;
            const totalB = isTele ? voteResults[b].teleTotal : voteResults[b].juryTotal;
            return totalB - totalA;
        });
 
    let html = `
        <h3 class="results-headline">${title}</h3>
        <div class="table-responsive">
            <table class="table table-striped eurovision-table">
                <thead>
                    <tr>
                        <th>Receiving Country</th>
                        <th>Genre</th>
                        ${votingOrder.map(country => `
                            <th class="rotate-header">
                                <div class="country-name">${country}</div>
                                <div class="flag-container">
                                    <span class="flag-icon flag-icon-${getCountryCode(country)}"></span>
                                </div>
                            </th>
                        `).join('')}
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
    `;
 
    sortedCountries.forEach((receiver, index) => {
        html += `
            <tr>
                <td class="receiving-country">
                    ${receiver}
                    <span class="flag-icon flag-icon-${getCountryCode(receiver)}"></span>
                </td>
                <td>${voteResults[receiver].genre}</td>
                ${votingOrder.map(voter => {
                    if (!voteResults[voter]) {
                        return '<td></td>';
                    }
                    const points = voter !== receiver ? (isTele ? voteResults[voter].teleVotesGiven[receiver] : voteResults[voter].juryVotesGiven[receiver]) || '' : '';
                    let cellClass = voter === receiver ? 'self-vote' : `points-${points}`;
                    return `<td class="${cellClass}">${points}</td>`;
                }).join('')}
                <td class="total-column">${isTele ? voteResults[receiver].teleTotal : voteResults[receiver].juryTotal}</td>
            </tr>
        `;
    });
 
    html += `
                </tbody>
            </table>
        </div>
    `;
 
    return html;
}
 
function simulateSemiFinalesDrawn() {
    if (!semiFinal1Results || !semiFinal2Results) {
        alert("Please generate contest results first.");
        return;
    }
 
    const allCountries = [...Object.keys(semiFinal1Results.results), ...Object.keys(semiFinal2Results.results)].sort();
 
    const drawSimulationDiv = document.createElement('div');
    drawSimulationDiv.className = 'col-md-10 draw-simulation';
    drawSimulationDiv.innerHTML = `
        <div class="card settings-card">
            <div class="card-body">
                <h2>Semi-Final Draw Simulation</h2>
                <button id="revealDrawButton" class="btn btn-primary mt-3 mb-3">Reveal Draw Results</button>
                <div class="row">
                    <div class="col-md-4">
                        <h3>1st Semi-Final</h3>
                        <table class="table table-striped">
                            <tbody id="semi1DrawnTable"></tbody>
                        </table>
                    </div>
                    <div class="col-md-4">
                        <h3>Countries</h3>
                        <table class="table table-striped">
                            <tbody id="allCountriesTable">
                                ${allCountries.map(country => `
                                    <tr>
                                        <td>
                                            ${country}
                                            <span class="flag-icon flag-icon-${getCountryCode(country)} ml-2"></span>
                                            <span class="genre-info">(${semiFinal1Results.results[country]?.genre || semiFinal2Results.results[country]?.genre})</span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-4">
                        <h3>2nd Semi-Final</h3>
                        <table class="table table-striped">
                            <tbody id="semi2DrawnTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    `;
 
    const mainRow = document.querySelector('.eurovision-simulator > .row');
 
    const existingDrawSimulation = mainRow.querySelector('.draw-simulation');
    if (existingDrawSimulation) {
        existingDrawSimulation.remove();
    }
 
    mainRow.appendChild(drawSimulationDiv);
 
    document.getElementById('revealDrawButton').addEventListener('click', () => {
        document.getElementById('revealDrawButton').style.display = 'none';
        const semi1Table = document.getElementById('semi1DrawnTable');
        const semi2Table = document.getElementById('semi2DrawnTable');
        const allCountriesTable = document.getElementById('allCountriesTable');
 
        const semi1Countries = Object.keys(semiFinal1Results.results);
        const semi2Countries = Object.keys(semiFinal2Results.results);
 
        let index = 0;
 
        function revealNextCountry() {
            if (index < allCountries.length) {
                const country = allCountries[index];
                const row = allCountriesTable.rows[index];
                row.style.opacity = '0.5';
 
                const newRow = document.createElement('tr');
                newRow.innerHTML = row.innerHTML;
                newRow.style.animation = 'fadeIn 1s';
 
                if (semi1Countries.includes(country)) {
                    semi1Table.appendChild(newRow);
                } else if (semi2Countries.includes(country)) {
                    semi2Table.appendChild(newRow);
                }
 
                index++;
                setTimeout(revealNextCountry, 2000);
            } else {
                document.getElementById('revealDrawButton').style.display = 'none';
            }
        }
 
        revealNextCountry();
    });
}
 
document.getElementById('simulateSemiDrawButton').addEventListener('click', simulateSemiFinalesDrawn);
 
function displayFinalResults(finalResults) {
    const { results, votingOrder } = finalResults;
    const sortedCountries = Object.keys(results)
        .filter(country => results[country].isCompeting)
        .sort((a, b) => {
            const totalA = results[a].juryTotal + results[a].teleTotal;
            const totalB = results[b].juryTotal + results[b].teleTotal;
            if (totalA !== totalB) return totalB - totalA;
            if (results[a].teleTotal !== results[b].teleTotal) return results[b].teleTotal - results[a].teleTotal;
            return tiebreaker(results[b], results[a]);
        });
 
    let html = `
        ${createVotingChart(finalResults, "Jury Voting - Final", false)}
        ${createVotingChart(finalResults, "Televoting - Final", true)}
        <h2 class="results-headline">Final Results</h2>
        <table class="table table-striped eurovision-table">
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Country</th>
                    <th>Genre</th>
                    <th>Jury Points</th>
                    <th>Tele Points</th>
                    <th>Total Points</th>
                    <th>Jury Odds</th>
                    <th>Tele Odds</th>
                    <th>Jury Placement</th>
                    <th>Tele Placement</th>
                </tr>
            </thead>
            <tbody>
    `;
 
    sortedCountries.forEach((country, index) => {
        html += `<tr class="${results[country].isAQ ? 'auto-qualifier' : ''}">
                <td>${index + 1}</td>
                <td style="text-align: right;">
                    ${country}
                    <span class="flag-icon flag-icon-${getCountryCode(country)} ml-2"></span>
                </td>
                <td>${results[country].genre}</td>
                <td class="points">${results[country].juryTotal}</td>
                <td class="points">${results[country].teleTotal}</td>
                <td class="points">${results[country].juryTotal + results[country].teleTotal}</td>
                <td class="placement">${results[country].juryOdds}</td>
                <td class="placement">${results[country].teleOdds}</td>
                <td class="placement">${results[country].juryPlacement}</td>
                <td class="placement">${results[country].telePlacement}</td>
            </tr>
        `;
    });

 
    html += `
            </tbody>
        </table>
    `;
 
    resultsDiv.innerHTML = html;
}
 
function tiebreaker(a, b, previousOrder) {
    // Compare total points
    const totalA = a.juryTotal + a.teleTotal;
    const totalB = b.juryTotal + b.teleTotal;
    if (totalA !== totalB) {
        return totalB - totalA;
    }

    // If total points are tied, compare televoting scores
    if (a.teleTotal !== b.teleTotal) {
        return b.teleTotal - a.teleTotal;
    }

    // If televoting scores are tied, compare jury scores
    if (a.juryTotal !== b.juryTotal) {
        return b.juryTotal - a.juryTotal;
    }

    // If jury scores are also tied, compare the number of countries that awarded points
    const aCountriesVoted = Object.values(a.teleVotesGiven).filter(v => v > 0).length;
    const bCountriesVoted = Object.values(b.teleVotesGiven).filter(v => v > 0).length;
    if (aCountriesVoted !== bCountriesVoted) {
        return bCountriesVoted - aCountriesVoted;
    }

    // If still tied, compare the number of 12 points received in televoting
    const aTele12 = Object.values(a.teleVotesGiven).filter(v => v === 12).length;
    const bTele12 = Object.values(b.teleVotesGiven).filter(v => v === 12).length;
    if (aTele12 !== bTele12) {
        return bTele12 - aTele12;
    }

    // Continue with 10 points, 8 points, etc. in televoting if needed
    const telePoints = [10, 8, 7, 6, 5, 4, 3, 2, 1];
    for (let point of telePoints) {
        const aCount = Object.values(a.teleVotesGiven).filter(v => v === point).length;
        const bCount = Object.values(b.teleVotesGiven).filter(v => v === point).length;
        if (aCount !== bCount) return bCount - aCount;
    }

    // If still tied, repeat the process for jury votes
    const aJury12 = Object.values(a.juryVotesGiven).filter(v => v === 12).length;
    const bJury12 = Object.values(b.juryVotesGiven).filter(v => v === 12).length;
    if (aJury12 !== bJury12) {
        return bJury12 - aJury12;
    }

    const juryPoints = [10, 8, 7, 6, 5, 4, 3, 2, 1];
    for (let point of juryPoints) {
        const aCount = Object.values(a.juryVotesGiven).filter(v => v === point).length;
        const bCount = Object.values(b.juryVotesGiven).filter(v => v === point).length;
        if (aCount !== bCount) return bCount - aCount;
    }

    // If everything is still tied, maintain the previous order
    if (previousOrder) {
        return previousOrder.indexOf(a.name) - previousOrder.indexOf(b.name);
    }

    // If no previous order is provided, countries remain in their current position
    return 0;
}
 
document.addEventListener('click', function(e) {
    if (e.target && e.target.id === 'showChartsButton') {
        chartContainer.style.display = 'block';
        chartContainer.innerHTML = `
            ${createVotingChart(currentSemiFinal === 1 ? semiFinal1Results : semiFinal2Results, `Jury Voting - Semi-Final ${currentSemiFinal}`, false)}
            ${createVotingChart(currentSemiFinal === 1 ? semiFinal1Results : semiFinal2Results, `Televoting - Semi-Final ${currentSemiFinal}`, true)}
            ${createSemiFinalTable(currentSemiFinal === 1 ? semiFinal1Results : semiFinal2Results)}
        `;
        e.target.style.display = 'none';
    }
});
 
document.querySelectorAll('.aq-checkbox').forEach(checkbox => {
    checkbox.disabled = !checkbox.previousElementSibling.previousElementSibling.checked;
});
 
document.getElementById('randomizeGenresButton').addEventListener('click', randomizeGenres);
 
const genreLikeabilityContainer = document.getElementById('genreLikeability');
genres.forEach(genre => {
    const div = document.createElement('div');
    div.innerHTML = `
        <label>${genre}:</label>
        <input type="number" class="genre-likeability" data-genre="${genre}" min="1" max="5" value="3">
    `;
    genreLikeabilityContainer.appendChild(div);
});
 
document.querySelectorAll('.genre-likeability').forEach(input => {
    input.addEventListener('change', (e) => {
        const genre = e.target.dataset.genre;
        const value = parseInt(e.target.value);
        if (value >= 1 && value <= 5) {
            genreLikeability[genre] = value;
        } else {
            e.target.value = genreLikeability[genre];
        }
    });
});
 
dynamicVotingButton.addEventListener('click', () => {
    const { results, votingOrder } = finalResults;
    const competingCountries = Object.keys(results).filter(country => results[country].isCompeting);
 
    dynamicVotingArea.innerHTML = '';
 
    let html = `
        <h2>Dynamic Voting Simulation</h2>
        <div class="table-responsive">
            <table class="table table-striped eurovision-table">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Receiving Country</th>
                        <th>Genre</th>
                        <th>Jury Points</th>
                        ${votingOrder.map(country => `
                            <th class="rotate-header">
                                <div class="country-name">${country}</div>
                                <div class="flag-container">
                                    <span class="flag-icon flag-icon-${getCountryCode(country)}"></span>
                                </div>
                            </th>
                        `).join('')}
                        <th>Televoting</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    ${competingCountries.map(country => `
                        <tr data-country="${country}">
                            <td class="rank"></td>
                            <td class="receiving-country">
                                ${country}
                                <span class="flag-icon flag-icon-${getCountryCode(country)}"></span>
                            </td>
                            <td class="genre">${results[country].genre}</td>
                            <td class="jury-points">0</td>
                            ${votingOrder.map(voter => `<td class="points-column" data-voter="${voter}"></td>`).join('')}
                            <td class="tele-points">0</td>
                            <td class="total-column">0</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
        <button id="nextJuryButton" class="btn btn-primary mt-3 reveal-button">Reveal Next Jury</button>
        <button id="revealTelevotingButton" class="btn btn-success mt-3 reveal-button" style="display: none;">Reveal Televoting</button>
        <div id="debugInfo" class="mt-3"></div>
    `;
 
    dynamicVotingArea.innerHTML = html;
 
    let currentJuryIndex = 0;
    let isTelevotingMode = false;
    let rows;
    let currentTeleIndex = 0;
 
    function updateTable() {
        const tableBody = document.querySelector('.eurovision-table tbody');
        if (!tableBody) {
            console.error('Table body not found');
            return;
        }
 
        const rows = Array.from(tableBody.querySelectorAll('tr'));
 
        const currentPositions = new Map(rows.map((row, index) => [row.dataset.country, index]));
 
        rows.sort((a, b) => {
            const aTotal = parseInt(a.querySelector('.total-column').textContent) || 0;
            const bTotal = parseInt(b.querySelector('.total-column').textContent) || 0;
            if (aTotal !== bTotal) {
                return bTotal - aTotal;
            }
            const aCountry = a.dataset.country || '';
            const bCountry = b.dataset.country || '';
            return aCountry.localeCompare(bCountry);
        });
 
        rows.forEach((row, newIndex) => {
            const country = row.dataset.country;
            const oldIndex = currentPositions.get(country);
            const rankCell = row.querySelector('.rank');
            const countryNameCell = row.querySelector('.receiving-country');
 
            if (newIndex !== oldIndex) {
                const direction = newIndex > oldIndex ? 'moving-down' : 'moving-up';
                row.classList.add(direction);
                setTimeout(() => row.classList.remove(direction), 2500);
 
                const distance = (newIndex - oldIndex) * row.offsetHeight;
                row.style.transform = `translateY(${distance}px)`;
 
                rankCell.textContent = newIndex + 1;
            }
 
            if (countryNameCell.classList.contains('tele-points-revealed')) {
                row.classList.add('tele-revealed');
            }
        });
 
        setTimeout(() => {
            rows.forEach(row => {
                row.style.transform = 'none';
                tableBody.appendChild(row);
                if (row.classList.contains('tele-revealed')) {
                    row.querySelector('.receiving-country').classList.add('tele-points-revealed');
                    row.classList.remove('tele-revealed');
                }
            });
        }, 800);
    }
 
    function revealNextJury() {
        if (currentJuryIndex < votingOrder.length) {
            const votingCountry = votingOrder[currentJuryIndex];
            console.log(`Revealing jury votes for: ${votingCountry}`);
            document.getElementById('debugInfo').innerText = `Current Jury: ${votingCountry}`;
 
            if (!results[votingCountry] || !results[votingCountry].juryVotesGiven) {
                console.error(`No jury votes found for ${votingCountry}`);
                currentJuryIndex++;
                revealNextJury();
                return;
            }
 
            const juryVotes = results[votingCountry].juryVotesGiven;
 
            Object.entries(juryVotes).forEach(([receiver, points]) => {
                const row = document.querySelector(`.eurovision-table tr[data-country="${receiver}"]`);
                if (row) {
                    const pointsCell = row.querySelector(`.points-column[data-voter="${votingCountry}"]`);
                    const juryPointsCell = row.querySelector('.jury-points');
                    const totalPointsCell = row.querySelector('.total-column');
 
                    if (pointsCell && juryPointsCell && totalPointsCell) {
                        pointsCell.textContent = points;
                        pointsCell.classList.add(`points-${points}`, 'fade-in');
                        if (votingCountry === receiver) {
                            pointsCell.classList.add('self-vote');
                        }
 
                        const currentJuryPoints = parseInt(juryPointsCell.textContent) || 0;
                        const newJuryPoints = currentJuryPoints + points;
 
                        juryPointsCell.textContent = newJuryPoints;
                        totalPointsCell.textContent = newJuryPoints;
 
                        console.log(`${votingCountry} gave ${points} points to ${receiver}`);
                    } else {
                        console.error(`Unable to find all cells for ${receiver}`);
                    }
                } else {
                    console.error(`Row not found for ${receiver}`);
                }
            });
 
            setTimeout(updateTable, 100);
            currentJuryIndex++;
 
            if (currentJuryIndex === votingOrder.length) {
                document.getElementById('nextJuryButton').style.display = 'none';
                document.getElementById('revealTelevotingButton').style.display = 'inline-block';
            }
        } else {
            console.log('All jury votes revealed');
            document.getElementById('nextJuryButton').style.display = 'none';
            document.getElementById('revealTelevotingButton').style.display = 'inline-block';
        }
    }
 
    document.getElementById('nextJuryButton').addEventListener('click', revealNextJury);
 
    function revealNextTele() {
        if (currentTeleIndex < rows.length) {
            const row = rows[currentTeleIndex];
            const country = row.dataset.country;
            if (!country || !results[country]) {
                console.error(`No data found for country at index ${currentTeleIndex}`);
                currentTeleIndex++;
                revealNextTele();
                return;
            }
            const telePoints = results[country].teleTotal;
 
            row.classList.add('current-televote');
 
            const telePointsCell = row.querySelector('.tele-points');
            const totalPointsCell = row.querySelector('.total-column');
            const juryPointsCell = row.querySelector('.jury-points');
            const countryNameCell = row.querySelector('.receiving-country');
 
            if (!telePointsCell || !totalPointsCell || !juryPointsCell || !countryNameCell) {
                console.error(`Required cells not found for ${country}`);
                currentTeleIndex++;
                revealNextTele();
                return;
            }
 
            const currentJuryPoints = parseInt(juryPointsCell.textContent) || 0;
            const newTotalPoints = currentJuryPoints + telePoints;
 
            setTimeout(() => {
                telePointsCell.textContent = telePoints;
                totalPointsCell.textContent = newTotalPoints;
                telePointsCell.classList.add('tele-points-revealed', 'fade-in');
                countryNameCell.classList.add('tele-points-revealed', 'fade-in');
                row.classList.add('highlight');
                row.classList.remove('current-televote');
                setTimeout(() => {
                    row.classList.remove('highlight');
                }, 800);
                setTimeout(updateTable, 800);
                currentTeleIndex++;
                if (currentTeleIndex === rows.length) {
                    document.getElementById('revealTelevotingButton').style.display = 'none';
                }
            }, 1000);
        }
    }
 
    document.getElementById('revealTelevotingButton').addEventListener('click', () => {
        if (!isTelevotingMode) {
            isTelevotingMode = true;
            document.getElementById('revealTelevotingButton').textContent = 'Reveal Next Televote';
 
            rows = Array.from(document.querySelectorAll('.eurovision-table tbody tr'));
            rows.sort((a, b) => {
                const aJuryPoints = parseInt(a.querySelector('.jury-points')?.textContent) || 0;
                const bJuryPoints = parseInt(b.querySelector('.jury-points')?.textContent) || 0;
                if (aJuryPoints !== bJuryPoints) {
                    return aJuryPoints - bJuryPoints;
                }
                const aCountry = a.querySelector('.receiving-country')?.textContent.trim() || '';
                const bCountry = b.querySelector('.receiving-country')?.textContent.trim() || '';
                return bCountry.localeCompare(aCountry);
            });
            currentTeleIndex = 0;
            const oldClickHandler = document.getElementById('revealTelevotingButton').onclick;
            if (oldClickHandler) {
                document.getElementById('revealTelevotingButton').removeEventListener('click', oldClickHandler);
            }
            document.getElementById('revealTelevotingButton').onclick = revealNextTele;
            revealNextTele();
        }
    });
 
    updateTable();
});
 
document.getElementById('resetButton').addEventListener('click', () => {
    // Reset checkboxes and AQ status
    document.querySelectorAll('.country-checkbox, .aq-checkbox').forEach(checkbox => {
        checkbox.checked = false;
        if (checkbox.classList.contains('aq-checkbox')) {
            checkbox.disabled = true;
        }
    });

    // Reset odds inputs
    document.querySelectorAll('.jury-odds-input, .tele-odds-input').forEach(input => {
        input.value = 100;
    });

    // Reset genre selections
    document.querySelectorAll('.genre-select').forEach(select => {
        select.selectedIndex = 0;
    });

    // Reset genre likeability
    genres.forEach(genre => genreLikeability[genre] = 3);
    updateGenreLikeabilityUI();


    // Reset min and max odds
    document.getElementById('minOdds').value = 1;
    document.getElementById('maxOdds').value = 500;

    // Reset reveal time
    document.getElementById('revealTime').value = 10;

    // Clear results and dynamic voting area
    resultsDiv.innerHTML = '';
    dynamicVotingArea.innerHTML = '';

    // Hide and clear chart containers
    const chartContainers = document.querySelectorAll('.semi-final-charts, #chartContainer');
    chartContainers.forEach(container => {
        container.innerHTML = '';
        container.style.display = 'none';
    });

    // Remove simulation areas
    const simulationAreas = document.querySelectorAll('#simulationArea');
    simulationAreas.forEach(area => area.remove());

    // Remove draw simulation
    const drawSimulation = document.querySelector('.draw-simulation');
    if (drawSimulation) {
        drawSimulation.remove();
    }

    // Reset results variables
    semiFinal1Results = null;
    semiFinal2Results = null;
    finalResults = null;
    currentSemiFinal = 1;

    // Reset button states
    document.getElementById('generateButton').disabled = false;
    semiFinal1Button.disabled = true;
    semiFinal2Button.disabled = true;
    finaleButton.disabled = true;
    simulateButton.disabled = true;
    dynamicVotingButton.disabled = true;
    document.getElementById('simulateSemiDrawButton').disabled = true;

    semiFinal1Button.classList.remove('btn-pink');
    semiFinal2Button.classList.remove('btn-pink');

    // Show settings card
    document.querySelector('.settings-card').style.display = 'block';

    // Scroll to top
    window.scrollTo(0, 0);

    // Update AQ checkbox status
    updateAQCheckboxStatus();
   
    document.querySelectorAll('.odds-input').forEach(input => {
        input.value = 100;
    });
 
 
    genres.forEach(genre => genreLikeability[genre] = 3);
    updateGenreLikeabilityUI();
 
    document.querySelectorAll('.genre-select').forEach(select => {
        select.selectedIndex = 0;
    });
 
    document.getElementById('generateButton').disabled = false;
 
    semiFinal1Button.disabled = true;
    semiFinal2Button.disabled = true;
    finaleButton.disabled = true;
    simulateButton.disabled = true;
    dynamicVotingButton.disabled = true;
    document.getElementById('simulateSemiDrawButton').disabled = true;
 
    semiFinal1Button.classList.remove('btn-pink');
    semiFinal2Button.classList.remove('btn-pink');
 
    document.querySelector('.settings-card').style.display = 'block';
 
    window.scrollTo(0, 0);
});
 
document.getElementById('instructionsButton').addEventListener('click', () => {
    const instructionsHTML = `
        <div class="modal fade" id="instructionsModal" tabindex="-1" aria-labelledby="instructionsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="instructionsModalLabel">Eurovision Simulator Instructions</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <h6>Welcome to the Eurovision Song Contest Simulator!</h6>
                        <p>This simulator allows you to create and run your own Eurovision-style contest. Here's what you can do:</p>
                        <ol>
                            <li><strong>Select Participating Countries:</strong> Choose from current and old contestants.</li>
                            <li><strong>Set Odds:</strong> Adjust the odds for each country (lower is better).</li>
                            <li><strong>Assign Genres:</strong> Select a genre for each country's song.</li>
                            <li><strong>Auto-Qualifiers:</strong> Mark countries as auto-qualifiers (up to 6).</li>
                            <li><strong>Randomize:</strong> Use buttons to randomize odds and genres.</li>
                            <li><strong>Adjust Diversity:</strong> Use the diversity slider to add variation to jury and televote scores.</li>
                            <li><strong>Genre Likeability:</strong> Set how well-liked each genre is, affecting voting patterns.</li>
                            <li><strong>Generate Results:</strong> Click 'GENERATE' to create contest results.</li>
                            <li><strong>View Charts:</strong> See detailed voting charts for semi-finals and finals.</li>
                            <li><strong>Simulate Draw:</strong> Watch a simulation of the semi-final draw.</li>
                            <li><strong>Dynamic Voting:</strong> Experience an interactive voting reveal for the final.</li>
                        </ol>
                        <p>Explore different scenarios, strategies, and see how changes in genres, odds, and preferences affect the contest outcomes!</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    `;
 
    document.body.insertAdjacentHTML('beforeend', instructionsHTML);
 
    const instructionsModal = new bootstrap.Modal(document.getElementById('instructionsModal'));
    instructionsModal.show();
});
 
document.getElementById('whatsNewButton').addEventListener('click', () => {
    const whatsNewHTML = `
        <div class="modal fade" id="whatsNewModal" tabindex="-1" aria-labelledby="whatsNewModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="whatsNewModalLabel">What's New in Eurovision Simulator</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
			<h6>Version 1.1.0 Updates and Bugfixes:</h6>
                        <ul>
			  <li style="color:green;"><ADDED> New mode which allows you to remove jury from the Semi-Finals. More systems soon!
			   <li style="color:green;"><ADDED> Custom countries with its custom icons. Credits for this function goes to: <a href="https://www.reddit.com/user/stems_twice/">@stems_twice</a>. Thank you!
		 	   <li style="color:orange;"><REMAKE> Separated odds for Televoting and Jury. Also the menu for odds got changed.
			   <li style="color:orange;"><REMAKE> Simulator allows now 10 Auto-Qualifiers and are available after choosing 27 or more all countries altogether.
			   <li>Hidden Odds in all charts and simulations</li>
                        </ul>
                        <h6>Version 1.0.1 Updates and Bugfixes:</h6>
                        <ul>
			   <li style="color:green;"><ADDED> this "What's New?" button to display recent changes and updates</li>
                            <li style="color:green;"><ADDED> new genres: Heavy Metal, Techno, and Rap</li>
                            <li>Genres are now displayed in a grid layout for better space utilization</li>
			    <li>Whole menu changed it's location and is now horizontal </li>
                            <li>Dynamic finale table now appears <u>above the charts</u></li>
                            <li>Added "AQ" label next to golden checkboxes auto-qualifier checkboxes for clarity</li>
                            <li>Fixed tiebreaker system for more accurate results</li>
                        </ul>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    `;
 
    document.body.insertAdjacentHTML('beforeend', whatsNewHTML);
 
    const whatsNewModal = new bootstrap.Modal(document.getElementById('whatsNewModal'));
    whatsNewModal.show();
});
 updateAQCheckboxStatus();
document.addEventListener('DOMContentLoaded', updateAQCheckboxStatus);
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
</body>
</html>
